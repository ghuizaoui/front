<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">

      <!-- ======= TITLE ======= -->
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Traitement des demandes</h4>
            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="javascript:void(0);">Demandes</a></li>
                <li class="breadcrumb-item active">Traitement</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- /TITLE -->

      <div class="row">
        <div class="col-lg-12">
          <div class="card" id="drhDemandesList">

            <!-- ======= TOOLBAR (recherche + bouton filter) ======= -->
            <div class="card-body pb-2 border-bottom">
              <div class="row g-2">
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="searchTerm"
                      (ngModelChange)="resetToFirstPage()"
                      placeholder="Rechercher : matricule, nom, prénom, type…" />
                    <!-- Bouton Filter -> OFFCANVAS #employeeFilters -->
                    <button class="btn btn-info"
                            type="button"
                            data-bs-toggle="offcanvas"
                            data-bs-target="#employeeFilters">
                      <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- /TOOLBAR -->

            <!-- ======= ALERTS ======= -->
            <div class="px-3">
              <div *ngIf="loading" class="alert alert-info mb-2">Chargement…</div>
              <div *ngIf="errorMessage" class="alert alert-danger mb-2">{{ errorMessage }}</div>
              <div *ngIf="successMessage" class="alert alert-success mb-2">{{ successMessage }}</div>
            </div>

            <!-- ======= TABLE ======= -->
            <div class="card-body pt-2">
              <!-- Compteur + taille de page (avec espace avant tableau) -->
              <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                <h6 class="card-title mb-0">
                  Demandes
                  <span class="badge bg-primary ms-1 align-baseline">{{ totalFiltered }}</span>
                </h6>

                <div class="d-flex align-items-center gap-2">
                  <label class="text-muted mb-0">Par page</label>
                  <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (ngModelChange)="goToPage(1)">
                    <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive table-card mt-3">
                <table class="table table-centered align-middle table-nowrap mb-0">
                  <thead class="table-light">

                  <!-- Ligne 1 : entêtes triables -->
                  <tr>
                    <th (click)="onSort('matricule')" role="button">
                      Matricule <i [class]="sortIcon('matricule')"></i>
                    </th>
                    <th (click)="onSort('nom')" role="button">
                      Nom <i [class]="sortIcon('nom')"></i>
                    </th>
                    <th (click)="onSort('prenom')" role="button">
                      Prénom <i [class]="sortIcon('prenom')"></i>
                    </th>
                    <th (click)="onSort('categorie')" role="button">
                      Catégorie <i [class]="sortIcon('categorie')"></i>
                    </th>
                    <th (click)="onSort('type')" role="button">
                      Type <i [class]="sortIcon('type')"></i>
                    </th>
                    <th (click)="onSort('dateDebut')" role="button">
                      Date début <i [class]="sortIcon('dateDebut')"></i>
                    </th>
                    <th (click)="onSort('dateFin')" role="button">
                      Date fin <i [class]="sortIcon('dateFin')"></i>
                    </th>
                    <th (click)="onSort('statut')" role="button">
                      Statut <i [class]="sortIcon('statut')"></i>
                    </th>
                    <th class="text-end" style="width: 110px;">Action</th>
                  </tr>

                  <!-- Ligne 2 : filtres d’en-tête -->
                  <tr>
                    <th>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="hfMatricule" (ngModelChange)="resetToFirstPage()"
                             placeholder="Filtrer…" />
                    </th>
                    <th>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="hfNom" (ngModelChange)="resetToFirstPage()"
                             placeholder="Filtrer…" />
                    </th>
                    <th>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="hfPrenom" (ngModelChange)="resetToFirstPage()"
                             placeholder="Filtrer…" />
                    </th>
                    <th>
                      <select class="form-select form-select-sm"
                              [(ngModel)]="hfCategorie" (ngModelChange)="resetToFirstPage()">
                        <option value="">Toutes</option>
                        <option *ngFor="let c of categorieOptionsView" [value]="c.value">{{ c.label }}</option>
                      </select>
                    </th>
                    <th>
                      <select class="form-select form-select-sm"
                              [(ngModel)]="hfType" (ngModelChange)="resetToFirstPage()">
                        <option value="">Tous</option>
                        <option *ngFor="let t of typeOptionsView" [value]="t.value">{{ t.label }}</option>
                      </select>
                    </th>
                    <th>
                      <input type="date" class="form-control form-control-sm"
                             [(ngModel)]="hfDateDebut" (ngModelChange)="resetToFirstPage()"/>
                    </th>
                    <th>
                      <input type="date" class="form-control form-control-sm"
                             [(ngModel)]="hfDateFin" (ngModelChange)="resetToFirstPage()"/>
                    </th>
                    <th>
                      <select class="form-select form-select-sm"
                              [(ngModel)]="hfStatut" (ngModelChange)="resetToFirstPage()">
                        <option value="">Tous</option>
                        <option *ngFor="let s of statutOptionsView" [value]="s.value">{{ s.label }}</option>
                      </select>
                    </th>
                    <th></th>
                  </tr>
                  </thead>

                  <tbody>
                  <tr *ngFor="let r of pagedRows">
                    <td>{{ r.employeMatricule || '-' }}</td>
                    <td>{{ r.employeNom || '-' }}</td>
                    <td>{{ r.employePrenom || '-' }}</td>
                    <td>{{ labelCategorie(r.categorie) }}</td>
                    <td>{{ labelType(r.typeDemande) }}</td>
                    <td>{{ fmtDate(r.dateDebut) }}</td>
                    <td>{{ fmtDate(r.dateFin) }}</td>
                    <td>
                      <span class="badge"
                            [ngClass]="{
                              'bg-secondary' : r.statut==='EN_COURS',
                              'bg-success'   : r.statut==='VALIDEE',
                              'bg-danger'    : r.statut==='REFUSEE'
                            }">
                        {{ labelStatut(r.statut) }}
                      </span>
                    </td>
                    <td class="text-end">
                      <button
                        class="btn btn-outline-primary btn-sm me-2"
                        title="Voir les détails"
                        (click)="openDetail(r.id)"
                        data-bs-toggle="modal"
                        data-bs-target="#detailModal">
                        <i class="bi bi-eye"></i>
                      </button>
                    </td>
                  </tr>
                  </tbody>
                </table>

                <div class="noresult" *ngIf="totalFiltered === 0">
                  <div class="text-center py-4">
                    <i class="ph-magnifying-glass fs-1 text-primary"></i>
                    <h5 class="mt-2">Aucun résultat</h5>
                    <p class="text-muted mb-0">Aucune demande ne correspond aux filtres.</p>
                  </div>
                </div>
              </div>

              <!-- Pagination -->
              <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 gap-2" *ngIf="totalFiltered > 0">
                <div class="text-muted">
                  Page {{ page }} / {{ totalPages }} —
                  <span class="text-body">{{ pagedRows.length }}</span> affichées
                  sur <span class="text-body">{{ totalFiltered }}</span> filtrées
                </div>
                <nav>
                  <ul class="pagination mb-0">
                    <li class="page-item" [class.disabled]="page === 1">
                      <a class="page-link" (click)="goToPage(1)">«</a>
                    </li>
                    <li class="page-item" [class.disabled]="page === 1">
                      <a class="page-link" (click)="prev()">‹</a>
                    </li>
                    <li class="page-item" *ngFor="let _ of [].constructor(totalPages); let i = index"
                        [class.active]="(i+1) === page"
                        [hidden]="Math.abs((i+1) - page) > 2 && (i+1) !== 1 && (i+1) !== totalPages">
                      <a class="page-link" (click)="goToPage(i+1)">{{ i+1 }}</a>
                    </li>
                    <li class="page-item" [class.disabled]="page === totalPages">
                      <a class="page-link" (click)="next()">›</a>
                    </li>
                    <li class="page-item" [class.disabled]="page === totalPages">
                      <a class="page-link" (click)="goToPage(totalPages)">»</a>
                    </li>
                  </ul>
                </nav>
              </div>

            </div><!-- /card-body -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======= OFFCANVAS : FILTRES (ID = employeeFilters) ======= -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="employeeFilters" aria-labelledby="employeeFiltersLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title" id="employeeFiltersLabel">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <div class="mb-3">
      <label class="form-label fw-semibold">Statut</label>
      <select class="form-select" [(ngModel)]="uiFilterStatus">
        <option value="">Tous les statuts</option>
        <option *ngFor="let s of statutOptionsView" [value]="s.value">{{ s.label }}</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">Type</label>
      <select class="form-select" [(ngModel)]="uiFilterType">
        <option value="">Tous les types</option>
        <option *ngFor="let t of typeOptionsView" [value]="t.value">{{ t.label }}</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">Catégorie</label>
      <select class="form-select" [(ngModel)]="uiFilterCategorie">
        <option value="">Toutes les catégories</option>
        <option *ngFor="let c of categorieOptionsView" [value]="c.value">{{ c.label }}</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">Tri</label>
      <select class="form-select" [(ngModel)]="uiSortBy">
        <option value="recent">Plus récents</option>
        <option value="ancien">Plus anciens</option>
        <option value="nomAZ">Nom A → Z</option>
        <option value="nomZA">Nom Z → A</option>
      </select>
    </div>
  </div>

  <div class="offcanvas-footer border-top p-3 d-flex gap-2">
    <button class="btn btn-subtle-danger w-100" (click)="resetFiltersUI()">Réinitialiser</button>
    <button class="btn btn-secondary w-100" (click)="applyFilters()" data-bs-dismiss="offcanvas">Appliquer</button>
  </div>
</div>

<!-- ======= MODAL : DÉTAIL + ACTIONS ======= -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true" #detailModal>
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content border-0">

      <!-- Header contextualisé -->
      <div class="modal-header"
           [ngClass]="{
             'bg-primary' : selected?.statut === 'EN_COURS',
             'bg-success' : selected?.statut === 'VALIDEE',
             'bg-danger'  : selected?.statut === 'REFUSEE'
           }">
        <h5 class="modal-title text-white" id="detailModalLabel">
          <i class="bi"
             [ngClass]="{
               'bi-hourglass-split': selected?.statut==='EN_COURS',
               'bi-check-circle':   selected?.statut==='VALIDEE',
               'bi-x-circle':       selected?.statut==='REFUSEE'
             }"></i>
          <span class="ms-2">
            Demande — {{ labelCategorie(selected?.categorie) }}
            <ng-container *ngIf="selected?.typeDemande"> · {{ labelType(selected?.typeDemande) }}</ng-container>
          </span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" (click)="closeDetail()"></button>
      </div>

      <div class="modal-body">

        <!-- Alerte d'état -->
        <div *ngIf="selected?.statut==='VALIDEE'" class="alert alert-success d-flex align-items-center" role="alert">
          <i class="bi bi-check2-circle me-2 fs-5"></i>
          <div>
            Cette demande est <strong>validée</strong>
            <ng-container *ngIf="selected?.dateValidation">
              (le {{ selected?.dateValidation | date:'dd/MM/yyyy HH:mm' }})
            </ng-container>.
          </div>
        </div>

        <div *ngIf="selected?.statut==='REFUSEE'" class="alert alert-danger d-flex align-items-start" role="alert">
          <i class="bi bi-x-octagon me-2 fs-5"></i>
          <div>
            <div>Cette demande est <strong>refusée</strong>
              <ng-container *ngIf="selected?.dateValidation">
                (le {{ selected?.dateValidation | date:'dd/MM/yyyy HH:mm' }})
              </ng-container>.
            </div>
            <div *ngIf="selected?.commentaireRefus" class="mt-1">
              <span class="fw-semibold">Motif :</span> {{ selected?.commentaireRefus }}
            </div>
          </div>
        </div>

        <!-- Employé -->
        <div class="card mb-3">
          <div class="card-header bg-light fw-semibold">
            <i class="bi bi-person-badge me-2"></i> Employé
          </div>
          <div class="card-body">
            <div class="mb-2">
              <span class="text-muted"><i class="bi bi-upc me-2"></i>Matricule :</span>
              <span class="fw-semibold ms-1">{{ selected?.employeMatricule || '-' }}</span>
            </div>
            <div>
              <span class="text-muted"><i class="bi bi-person me-2"></i>Nom et prénom :</span>
              <span class="fw-semibold ms-1">{{ selected?.employeNom || '' }} {{ selected?.employePrenom || '' }}</span>
            </div>
          </div>
        </div>

        <!-- Informations -->
        <div class="card mb-3">
          <div class="card-header bg-light fw-semibold">
            <i class="bi bi-info-circle me-2"></i> Informations
          </div>
          <div class="card-body">
            <div class="mb-2">
              <span class="text-muted"><i class="bi bi-diagram-3 me-2"></i>Catégorie :</span>
              <span class="fw-semibold ms-1">{{ labelCategorie(selected?.categorie) }}</span>
            </div>
            <div class="mb-2">
              <span class="text-muted"><i class="bi bi-tag me-2"></i>Type :</span>
              <span class="fw-semibold ms-1">{{ labelType(selected?.typeDemande) }}</span>
            </div>
            <div class="mb-2">
              <span class="text-muted"><i class="bi bi-calendar-plus me-2"></i>Date création :</span>
              <span class="fw-semibold ms-1">{{ selected?.dateCreation | date:'dd/MM/yyyy' }}</span>
            </div>
            <div>
              <span class="text-muted"><i class="bi bi-clock me-2"></i>Heure création :</span>
              <span class="fw-semibold ms-1">{{ selected?.dateCreation | date:'HH:mm' }}</span>
            </div>
          </div>
        </div>

        <!-- Période / Détails -->
        <div class="card">
          <div class="card-header bg-light fw-semibold">
            <i class="bi bi-calendar-event me-2"></i> Période / Détails
          </div>
          <div class="card-body">

            <!-- CONGÉS -->
            <ng-container *ngIf="selected?.categorie === 'CONGE_STANDARD' || selected?.categorie === 'CONGE_EXCEPTIONNEL'">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-flag me-2"></i>Début</div>
                    <div class="mb-1"><span class="text-muted">Date :</span> <strong>{{ selected?.congeDateDebut | date:'dd/MM/yyyy' }}</strong></div>
                    <div class="mb-0"><span class="text-muted">Heure :</span> <strong>{{ selected?.congeHeureDebut ? (selected?.congeHeureDebut | slice:0:5) : '-' }}</strong></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-flag-fill me-2"></i>Fin</div>
                    <div class="mb-1"><span class="text-muted">Date :</span> <strong>{{ selected?.congeDateFin | date:'dd/MM/yyyy' }}</strong></div>
                    <div class="mb-0"><span class="text-muted">Heure :</span> <strong>{{ selected?.congeHeureFin ? (selected?.congeHeureFin | slice:0:5) : '-' }}</strong></div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- AUTORISATION -->
            <ng-container *ngIf="selected?.categorie === 'AUTORISATION'">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-calendar-day me-2"></i>Jour</div>
                    <div class="mb-0"><span class="text-muted">Date :</span> <strong>{{ selected?.autoDate | date:'dd/MM/yyyy' }}</strong></div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-clock me-2"></i>Plage prévue</div>
                    <div class="mb-0">
                      <span class="text-muted">Heures :</span>
                      <strong>
                        {{ selected?.autoHeureDebut ? (selected?.autoHeureDebut | slice:0:5) : '-' }}
                        &nbsp;→&nbsp;
                        {{ selected?.autoHeureFin ? (selected?.autoHeureFin | slice:0:5) : '-' }}
                      </strong>
                    </div>
                  </div>
                </div>

                <div class="col-12" *ngIf="selected?.autoDateReelle || selected?.autoHeureSortieReelle || selected?.autoHeureRetourReel">
                  <div class="border rounded p-3">
                    <div class="fw-semibold mb-2"><i class="bi bi-activity me-2"></i>Réalisation</div>
                    <div class="row">
                      <div class="col-md-4"><span class="text-muted">Date :</span> <strong>{{ selected?.autoDateReelle | date:'dd/MM/yyyy' }}</strong></div>
                      <div class="col-md-4"><span class="text-muted">Sortie :</span> <strong>{{ selected?.autoHeureSortieReelle ? (selected?.autoHeureSortieReelle | slice:0:5) : '-' }}</strong></div>
                      <div class="col-md-4"><span class="text-muted">Retour :</span> <strong>{{ selected?.autoHeureRetourReel ? (selected?.autoHeureRetourReel | slice:0:5) : '-' }}</strong></div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- ORDRE DE MISSION -->
            <ng-container *ngIf="selected?.categorie === 'ORDRE_MISSION'">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-flag me-2"></i>Début</div>
                    <div class="mb-1"><span class="text-muted">Date :</span> <strong>{{ selected?.missionDateDebut | date:'dd/MM/yyyy' }}</strong></div>
                    <div class="mb-0"><span class="text-muted">Heure :</span> <strong>{{ selected?.missionHeureDebut ? (selected?.missionHeureDebut | slice:0:5) : '-' }}</strong></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="fw-semibold mb-2"><i class="bi bi-flag-fill me-2"></i>Fin</div>
                    <div class="mb-1"><span class="text-muted">Date :</span> <strong>{{ selected?.missionDateFin | date:'dd/MM/yyyy' }}</strong></div>
                    <div class="mb-0"><span class="text-muted">Heure :</span> <strong>{{ selected?.missionHeureFin ? (selected?.missionHeureFin | slice:0:5) : '-' }}</strong></div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="border rounded p-3">
                    <div class="fw-semibold mb-1"><i class="bi bi-journal-text me-2"></i>Objet</div>
                    <div>{{ selected?.missionObjet || '-' }}</div>
                  </div>
                </div>
              </div>
            </ng-container>

          </div>
        </div>

        <!-- Carte : Motif de refus (uniquement si EN_COURS) -->
        <div class="card mt-3" *ngIf="selected?.statut==='EN_COURS'">
          <div class="card-header bg-light fw-semibold">
            <i class="bi bi-chat-left-text me-2"></i> Motif de refus
          </div>
          <div class="card-body">
            <label class="form-label mb-1">Expliquez la raison <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3"
                      [(ngModel)]="refuseComment"
                      placeholder="Saisir le motif (requis pour refuser)…"></textarea>
            <div class="form-text mt-1">
              Ce motif sera notifié au demandeur si vous refusez la demande.
            </div>
          </div>
        </div>

      </div>

      <!-- Actions (seulement EN_COURS) -->
      <div class="modal-footer" *ngIf="selected?.statut==='EN_COURS'">
        <button class="btn btn-danger" [disabled]="!refuseComment?.trim()" (click)="confirmRefuse()" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Refuser
        </button>
        <button class="btn btn-success" (click)="approve()" data-bs-dismiss="modal">
          <i class="bi bi-check2-circle me-1"></i> Valider
        </button>
      </div>

    </div>
  </div>
</div>
