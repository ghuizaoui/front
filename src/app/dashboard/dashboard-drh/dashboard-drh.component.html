<!-- dashboard-drh.component.html -->
<div class="dashboard-container" style="padding-top: 10em;">
    <app-welcome-card-employe></app-welcome-card-employe>
    
    <!-- Date Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label>P√©riode g√©n√©rale:</label>
            <input type="date" [(ngModel)]="startDate" (change)="applyFilters()">
            <span>au</span>
            <input type="date" [(ngModel)]="endDate" (change)="applyFilters()">
        </div>
        
        <div class="filter-group">
            <label>P√©riode statut:</label>
            <input type="date" [(ngModel)]="statusStartDate" (change)="applyFilters()">
            <span>au</span>
            <input type="date" [(ngModel)]="statusEndDate" (change)="applyFilters()">
        </div>
        
        <button (click)="applyFilters()" class="apply-btn">Appliquer les filtres</button>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Chargement des donn√©es...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage && !isLoading" class="error-message">
        {{ errorMessage }}
    </div>

    <!-- Main Dashboard Content -->
    <div *ngIf="!isLoading && !errorMessage" class="dashboard-content">
        
        <!-- Navigation Tabs -->
        <div class="dashboard-tabs">
            <button [class.active]="activeTab === 'overview'" (click)="activeTab = 'overview'">
                üìä Vue d'ensemble
            </button>
            <button [class.active]="activeTab === 'status'" (click)="activeTab = 'status'">
                üìã R√©partition statuts
            </button>
            <button [class.active]="activeTab === 'categories'" (click)="activeTab = 'categories'">
                üìà Cat√©gories & Types
            </button>
            <button [class.active]="activeTab === 'leave'" (click)="activeTab = 'leave'">
                üèñÔ∏è Cong√©s & Soldes
            </button>
            <button [class.active]="activeTab === 'accepted'" (click)="activeTab = 'accepted'">
                ‚úÖ Demandes accept√©es
            </button>
        </div>

        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="tab-content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card large">
                    <div class="kpi-title">Demandes totales</div>
                    <div class="kpi-value">{{ overviewData?.totalDemandes || 0 }}</div>
                    <div class="kpi-subtitle">sur {{ overviewData?.totalPossible || 0 }} possibles</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-title">Taux de demande</div>
                    <div class="kpi-value">{{ formatPercentage(overviewData?.percentage || 0) }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width]="overviewData?.percentage + '%'"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Distribution Tab -->
        <div *ngIf="activeTab === 'status'" class="tab-content">
            <h3>R√©partition des statuts des demandes</h3>
            
            <div class="chart-container">
                <app-generic-chart
                [chartData]="getStatusDistributionChartData().data"
                [chartCategories]="getStatusDistributionChartData().categories"
                [chartType]="'pie'"
                [chartTitle]="'R√©partition des statuts des demandes'"
                [seriesName]="'Statuts'">
              </app-generic-chart>
            </div>
            
            <div class="status-details">
                <div *ngFor="let status of statusDistribution" class="status-item">
                    <span class="status-badge" [class]="'status-' + status.status.toLowerCase()"></span>
                    <span class="status-name">{{ status.status }}</span>
                    <span class="status-count">{{ status.count }} demandes</span>
                    <span class="status-percentage">{{ formatPercentage(status.percentage) }}</span>
                </div>
            </div>
        </div>

        <!-- Categories & Types Tab -->
        <div *ngIf="activeTab === 'categories'" class="tab-content">
            <div class="category-header">
                <h3>R√©partition des demandes par cat√©gorie et type</h3>
                
                <div class="view-toggle">
                    <button 
                        [class.active]="categoryViewMode === 'aggregated'" 
                        (click)="switchCategoryView('aggregated')"
                        class="toggle-btn">
                        üìä Vue agr√©g√©e
                    </button>
                    <button 
                        [class.active]="categoryViewMode === 'detailed'" 
                        (click)="switchCategoryView('detailed')"
                        class="toggle-btn">
                        üìã Vue d√©taill√©e
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <app-generic-chart
                    [chartData]="getCurrentCategoryChartData().data"
                    [chartCategories]="getCurrentCategoryChartData().categories"
                    [chartType]="getCategoryChartType()"
                    [chartTitle]="getCategoryChartTitle()"
                    [seriesName]="getCategorySeriesName()"
                ></app-generic-chart>
            </div>
            
            <!-- Detailed View Table -->
            <div *ngIf="categoryViewMode === 'detailed'" class="category-details">
                <h4>D√©tails par cat√©gorie et type</h4>
                <div class="category-table-container">
                    <table class="category-table">
                        <thead>
                            <tr>
                                <th>Cat√©gorie</th>
                                <th>Type de demande</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of categoryTypeDistribution" class="category-item">
                                <td class="category-name">
                                    <span class="category-badge" [class]="'category-' + item.categorie.toLowerCase()"></span>
                                    {{ item.categorie }}
                                </td>
                                <td class="type-name">{{ item.typeDemande }}</td>
                                <td class="type-count">{{ item.count }}</td>
                                <td class="type-percentage">{{ formatPercentage(item.percentage) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Aggregated View Table -->
            <div *ngIf="categoryViewMode === 'aggregated'" class="category-summary">
                <h4>R√©sum√© par cat√©gorie</h4>
                <div class="category-list">
                    <div *ngFor="let category of categoryDistribution" class="category-summary-item">
                        <div class="category-info">
                            <span class="category-badge" [class]="'category-' + category.categorie.toLowerCase()"></span>
                            <span class="category-label">{{ category.categorie }}</span>
                        </div>
                        <div class="category-stats">
                            <span class="category-total">{{ category.count }} demandes</span>
                            <span class="category-percentage">{{ formatPercentage(category.percentage) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Balance Tab -->
        <div *ngIf="activeTab === 'leave'" class="tab-content">
            <h3>Jours de cong√©s pris et solde</h3>
            
            <div class="leave-overview">
                <div class="leave-card">
                    <h4>üìä Vue d'ensemble</h4>
                    <div class="leave-stats">
                        <div class="stat">
                            <span class="label">Jours pris:</span>
                            <span class="value">{{ leaveBalance?.joursPris || 0 }}</span>
                        </div>
                        <div class="stat">
                            <span class="label">Solde total:</span>
                            <span class="value">{{ leaveBalance?.soldeTotal || 0 }}</span>
                        </div>
                        <div class="stat">
                            <span class="label">Pourcentage pris:</span>
                            <span class="value">{{ formatPercentage(leaveBalance?.percentagePris || 0) }}</span>
                        </div>
                        <div class="stat">
                            <span class="label">Solde restant:</span>
                            <span class="value highlight">{{ leaveBalance?.soldeRestant || 0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <app-generic-chart
                    [chartData]="getLeaveByServiceChartData().data"
                    [chartCategories]="getLeaveByServiceChartData().categories"
                    chartTitle="Cong√©s pris par service"
                    chartType="bar"
                    seriesName="Jours pris"
                    color="#10b981"
                    [showLegend]="false"
                ></app-generic-chart>
            </div>
            
            <div class="service-breakdown">
                <h4>Ventilation par service</h4>
                <div class="service-list">
                    <div *ngFor="let service of leaveByService" class="service-item">
                        <span class="service-name">{{ service.service }}</span>
                        <span class="service-days">{{ service.joursPris }} jours</span>
                        <span class="service-percentage">{{ formatPercentage(service.percentage) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accepted Requests Tab -->
        <div *ngIf="activeTab === 'accepted'" class="tab-content">
            <h3>Demandes accept√©es par service</h3>
            
            <div class="chart-container">
                <app-generic-chart
                    [chartData]="getAcceptedRequestsChartData().data"
                    [chartCategories]="getAcceptedRequestsChartData().categories"
                    chartTitle="Demandes accept√©es par service"
                    chartType="bar"
                    seriesName="Demandes accept√©es"
                    color="#f59e0b"
                    [showLegend]="false"
                ></app-generic-chart>
            </div>
            
            <div class="accepted-requests-table">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Demandes accept√©es</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let request of acceptedRequests">
                            <td>{{ request.service }}</td>
                            <td>{{ request.demandesAcceptees }}</td>
                            <td>
                                <button (click)="loadEmployeeLeaveBalance(request.service)" class="details-btn">
                                    Voir d√©tails
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Employee Details View -->
            <div *ngIf="showEmployeeDetails" class="employee-details">
                <div class="details-header">
                    <h4>D√©tails des employ√©s - {{ selectedService }}</h4>
                    <button (click)="resetView()" class="back-btn">‚Üê Retour</button>
                </div>
                
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>Solde cong√©s</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let employee of employeeLeaveBalance" 
                            [class.highlight]="employee.hasHighestBalance">
                            <td>{{ employee.nom }}</td>
                            <td>{{ employee.prenom }}</td>
                            <td>{{ employee.soldeConges }} jours</td>
                            <td>
                                <span *ngIf="employee.hasHighestBalance" class="highest-badge">
                                    Plus haut solde
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>