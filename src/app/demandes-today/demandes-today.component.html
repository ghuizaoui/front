<div class="main-content">
    <!-- En-t√™te de page -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">üìã Demandes du Jour</h1>
        <button class="btn btn-primary" (click)="loadDemandes()" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            {{ loading ? 'Chargement...' : 'üîÑ Actualiser' }}
        </button>
    </div>

    <!-- Carte des filtres -->
    <div class="card filters-card">
        <div class="card-body">
            <div class="row g-3">
                <!-- Recherche -->
                <div class="col-md-4">
                    <label class="form-label">üîç Rechercher</label>
                    <div class="search-box">
                        <input 
                            type="text" 
                            class="form-control search-input" 
                            placeholder="Nom, pr√©nom, matricule..."
                            [(ngModel)]="searchTerm"
                            (input)="applyFilters()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>

                <!-- Filtre Cat√©gorie -->
                <div class="col-md-3">
                    <label class="form-label">üìÇ Cat√©gorie</label>
                    <select 
                        class="form-select filter-select" 
                        [(ngModel)]="selectedCategorie"
                        (change)="applyFilters()">
                        <option *ngFor="let cat of categories" [value]="cat.value">
                            {{ cat.label }}
                        </option>
                    </select>
                </div>

                <!-- Filtre Statut -->
                <div class="col-md-3">
                    <label class="form-label">üìä Statut</label>
                    <select 
                        class="form-select filter-select" 
                        [(ngModel)]="selectedStatut"
                        (change)="applyFilters()">
                        <option *ngFor="let statut of statuts" [value]="statut.value">
                            {{ statut.label }}
                        </option>
                    </select>
                </div>

                <!-- Bouton Effacer les filtres -->
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button 
                        class="btn-clear-filters" 
                        (click)="clearFilters()"
                        [disabled]="searchTerm === '' && selectedCategorie === 'all' && selectedStatut === 'all'">
                        <span class="clear-icon">üóëÔ∏è</span>
                        Effacer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Information des r√©sultats -->
    <div class="results-info mb-3">
        <span class="results-count">{{ filteredDemandes.length }}</span>
        demande(s) trouv√©e(s)
    </div>

    <!-- Message d'erreur -->
    <div *ngIf="error" class="alert alert-danger mb-4">
        <span class="alert-icon">‚ö†Ô∏è</span>
        {{ error }}
    </div>

    <!-- Carte principale des demandes -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìã Liste des Demandes</h2>
        </div>

        <div class="card-body p-0">
            <!-- √âtat de chargement -->
            <div *ngIf="loading" class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-3 text-muted">Chargement des demandes...</p>
            </div>

            <!-- Aucune donn√©e -->
            <div *ngIf="!loading && filteredDemandes.length === 0" class="no-data-message">
                <div class="no-data-icon">üì≠</div>
                <h4>Aucune demande trouv√©e</h4>
                <p *ngIf="demandes.length === 0">Aucune demande n'a √©t√© cr√©√©e aujourd'hui.</p>
                <p *ngIf="demandes.length > 0 && filteredDemandes.length === 0">
                    Aucune demande ne correspond aux crit√®res de recherche.
                </p>
                <button *ngIf="demandes.length > 0" class="btn btn-primary" (click)="clearFilters()">
                    Afficher toutes les demandes
                </button>
            </div>

            <!-- Tableau des demandes -->
            <div *ngIf="!loading && filteredDemandes.length > 0" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Employ√©</th>
                            <th>Matricule</th>
                            <th>Cat√©gorie</th>
                            <th>Type</th>
                            <th>Date D√©but</th>
                            <th>Date Fin</th>
                            <th>Heure D√©but</th>
                            <th>Heure Fin</th>
                            <th>Objet Mission</th>
                            <th>Statut</th>
                            <th>Lib√©ration</th>
                            <th>Date Cr√©ation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let demande of filteredDemandes" class="demande-row">
                            <!-- Informations employ√© -->
                            <td>
                                <div class="employee-info">
                                    <span class="employee-name">
                                        {{ demande.employe?.prenom }} {{ demande.employe?.nom }}
                                    </span>
                                    <span class="employee-email">{{ demande.employe?.email }}</span>
                                </div>
                            </td>

                            <!-- Matricule -->
                            <td>
                                <span class="matricule-badge">
                                    {{ demande.employe?.matricule || '-' }}
                                </span>
                            </td>

                            <!-- Cat√©gorie -->
                            <td>
                                <span class="category-badge {{ getCategoryClass(demande.categorie) }}">
                                    {{ getCategoryLabel(demande.categorie) }}
                                </span>
                            </td>

                            <!-- Type -->
                            <td>
                                <span class="text-muted">
                                    {{ demande.typeDemande || '-' }}
                                </span>
                            </td>

                            <!-- Dates et heures selon la cat√©gorie -->
                            <td>
                                {{ 
                                    demande.congeDateDebut ? formatDate(demande.congeDateDebut) :
                                    demande.autoDateDebut ? formatDate(demande.autoDateDebut) :
                                    demande.missionDateDebut ? formatDate(demande.missionDateDebut) : '-'
                                }}
                            </td>

                            <td>
                                {{ 
                                    demande.congeDateFin ? formatDate(demande.congeDateFin) :
                                    demande.autoDateFin ? formatDate(demande.autoDateFin) :
                                    demande.missionDateFin ? formatDate(demande.missionDateFin) : '-'
                                }}
                            </td>

                            <td>
                                {{ 
                                    demande.congeHeureDebut ? formatTime(demande.congeHeureDebut) :
                                    demande.autoHeureDebut ? formatTime(demande.autoHeureDebut) :
                                    demande.missionHeureDebut ? formatTime(demande.missionHeureDebut) : '-'
                                }}
                            </td>

                            <td>
                                {{ 
                                    demande.congeHeureFin ? formatTime(demande.congeHeureFin) :
                                    demande.autoHeureFin ? formatTime(demande.autoHeureFin) :
                                    demande.missionHeureFin ? formatTime(demande.missionHeureFin) : '-'
                                }}
                            </td>

                            <!-- Objet mission -->
                            <td>
                                <span class="mission-objet" [title]="demande.missionObjet || ''">
                                    {{ demande.missionObjet || '-' }}
                                </span>
                            </td>

                            <!-- Statut -->
                            <td>
                                <span class="status-badge {{ getStatusClass(demande.statut) }}">
                                    {{ getStatusLabel(demande.statut) }}
                                </span>
                            </td>

                            <!-- NEW: Liberation Status -->
                            <td>
                                <span class="liberation-badge {{ getLiberationClass(demande) }}">
                                    {{ getLiberationLabel(demande) }}
                                </span>
                            </td>

                            <!-- Date cr√©ation -->
                            <td>
                                <span class="text-muted">
                                    {{ formatDate(demande.dateCreation || '') }}
                                </span>
                            </td>

                            <!-- NEW: Actions -->
                            <td>
                                <button class="btn btn-sm btn-success liberation-btn" 
                                        *ngIf="canLiberateDemande(demande)"
                                        (click)="openLiberationModal(demande)"
                                        title="Lib√©rer cette demande">
                                    <span class="liberation-icon">‚úì</span>
                                    Lib√©rer
                                </button>
                                <span class="text-muted" *ngIf="!canLiberateDemande(demande)">
                                    -
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Liberation Modal -->
<div class="modal-backdrop fade show" *ngIf="showLiberationModal"></div>
<div class="modal fade show d-block" *ngIf="showLiberationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la lib√©ration</h5>
                <button type="button" class="btn-close" (click)="closeLiberationModal()" [disabled]="isLiberating"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Demande s√©lectionn√©e:</strong><br>
                    {{ selectedDemandeForLiberation?.employe?.prenom }} {{ selectedDemandeForLiberation?.employe?.nom }}<br>
                    {{ getCategoryLabel(selectedDemandeForLiberation?.categorie || '') }} - 
                    {{ safeFormatDate(
                        selectedDemandeForLiberation?.congeDateDebut ||
                        selectedDemandeForLiberation?.autoDateDebut ||
                        selectedDemandeForLiberation?.missionDateDebut
                    ) }}
                      
                </div>
                
                <div class="mb-3">
                    <label for="liberationComment" class="form-label">Commentaire (optionnel)</label>
                    <textarea class="form-control" id="liberationComment" 
                              [(ngModel)]="liberationComment"
                              placeholder="Ajouter un commentaire..."
                              rows="3"
                              [disabled]="isLiberating"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" 
                        (click)="closeLiberationModal()" 
                        [disabled]="isLiberating">
                    Annuler
                </button>
                <button type="button" class="btn btn-success" 
                        (click)="libererDemande()"
                        [disabled]="isLiberating">
                    <span class="spinner-border spinner-border-sm" *ngIf="isLiberating"></span>
                    {{ isLiberating ? 'Lib√©ration...' : 'Confirmer la lib√©ration' }}
                    lib√©ration

                </button>
            </div>
        </div>
    </div>
</div>